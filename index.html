<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OrbitFeed — Astronomy Pictures (APOD)</title>
  <meta name="description" content="OrbitFeed — Daily astronomy images from NASA APOD. Clean magazine UI inspired by MIT Technology Review." />

  <!-- Fonts (MIT Tech Review-like feel) -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent:#c21807;
      --muted:#6b6b6b;
      --max-width:1150px;
      --card-radius:12px;
      --bg:#fbfbfb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#111;-webkit-font-smoothing:antialiased}

    /* Header */
    header{background:#fff;border-bottom:1px solid #eee;position:sticky;top:0;z-index:40}
    .top{max-width:var(--max-width);margin:0 auto;padding:20px 18px;display:flex;align-items:center;gap:18px}
    .brand{display:flex;flex-direction:column}
    .brand .title{font-family:Merriweather,serif;font-size:28px;margin:0}
    .brand .kicker{font-size:12px;color:var(--muted)}
    .search{margin-left:auto;display:flex;gap:8px;align-items:center}
    .search input{padding:8px 12px;border-radius:8px;border:1px solid #e6e6e6;min-width:220px}

    /* Layout */
    .wrap{max-width:var(--max-width);margin:28px auto;padding:0 18px;display:grid;grid-template-columns:1fr 360px;gap:28px}
    @media (max-width:980px){.wrap{grid-template-columns:1fr;padding:0 12px}.search{display:none}}

    /* Hero */
    .hero{background:#fff;border-radius:var(--card-radius);overflow:hidden;box-shadow:0 10px 30px rgba(20,20,20,0.04)}
    .hero-media{width:100%;height:460px;background:#111;display:flex;align-items:center;justify-content:center}
    .hero-media img{width:100%;height:100%;object-fit:cover}
    .hero-content{padding:18px}
    .hero-content h1{font-family:Merriweather,serif;margin:0 0 8px;font-size:22px}
    .hero-content p{margin:0;color:var(--muted)}
    .hero-meta{margin-top:10px;font-size:13px;color:var(--muted)}

    /* Feed */
    .feed-header{display:flex;justify-content:space-between;align-items:center;margin:16px 0}
    .cards{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.cards{grid-template-columns:1fr 1fr}}

    .card{background:#fff;border-radius:10px;display:flex;gap:12px;padding:12px;align-items:flex-start;box-shadow:0 8px 24px rgba(20,20,20,0.04)}
    .card .thumb{width:160px;height:100px;border-radius:8px;overflow:hidden;background:#ddd;flex:0 0 160px}
    .card .thumb img{width:100%;height:100%;object-fit:cover}
    .card .meta{flex:1}
    .meta h3{margin:0;font-size:16px}
    .meta p{margin:8px 0 0;color:var(--muted);font-size:13px}
    .meta .metaLine{margin-top:8px;font-size:12px;color:var(--muted)}

    /* Sidebar */
    aside .panel{background:#fff;border-radius:10px;padding:14px;box-shadow:0 8px 24px rgba(20,20,20,0.04);margin-bottom:14px}
    .panel h4{margin:0 0 8px 0}
    .small{font-size:13px;color:var(--muted)}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(10,10,10,0.6);display:flex;align-items:center;justify-content:center;padding:20px;z-index:80}
    .modal .sheet{background:#fff;border-radius:12px;max-width:1000px;width:100%;max-height:90vh;overflow:auto}
    .modal .media{height:60vh}
    .modal .content{padding:18px}

    /* Buttons */
    .btn{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .link{color:var(--accent);text-decoration:none;font-weight:600}

    footer{text-align:center;color:var(--muted);padding:28px 0}

    /* small helpers */
    .muted{color:var(--muted)}
    .skeleton{background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:shimmer 1.2s linear infinite}
    @keyframes shimmer{from{background-position:200% 0} to{background-position:-200% 0}}
  </style>
</head>
<body>
  <header>
    <div class="top">
      <div class="brand">
        <div class="title">OrbitFeed</div>
        <div class="kicker">Daily astronomy images & mini-magazine</div>
      </div>
      <div class="search">
        <input id="q" placeholder="Search title or explanation" />
        <button id="refresh" class="btn">Refresh</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section>
      <div class="hero" id="hero">
        <div class="hero-media skeleton" id="heroMedia"></div>
        <div class="hero-content">
          <h1 id="heroTitle">Loading latest Astronomy Picture...</h1>
          <p id="heroDesc" class="muted">Fetching images from NASA APOD. If the API fails, cached results or local fallbacks will be used.</p>
          <div class="hero-meta muted" id="heroMeta"></div>
        </div>
      </div>

      <div class="feed-header">
        <h2 style="margin:0">Recent APODs</h2>
        <div class="small" id="feedMeta">Last 8 days</div>
      </div>

      <div class="cards" id="cards"></div>
    </section>

    <aside>
      <div class="panel">
        <h4>About OrbitFeed</h4>
        <p class="small">OrbitFeed shows the Astronomy Picture of the Day (APOD) from NASA with a clean magazine-style layout inspired by MIT Technology Review. Images are cached locally for reliability.</p>
      </div>

      <div class="panel">
        <h4>Quick actions</h4>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="openToday" class="btn">Open today's</button>
          <button id="downloadAll" class="btn">Download images</button>
        </div>
      </div>

      <div class="panel">
        <h4>Settings</h4>
        <div class="small">API key (optional):</div>
        <input id="apiKey" placeholder="NASA API key (optional)" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #eee" />
        <div style="margin-top:8px" class="small muted">Using <strong>DEMO_KEY</strong> has rate limits. Add your key for higher limits.</div>
      </div>
    </aside>
  </main>

  <footer>OrbitFeed • Images from NASA APOD • Save & share your favorites</footer>

  <!-- Modal (hidden initially) -->
  <div id="modal" style="display:none" class="modal" onclick="closeModal(event)">
    <div class="sheet" onclick="event.stopPropagation()">
      <div class="media" id="modalMedia"></div>
      <div class="content">
        <h3 id="modalTitle"></h3>
        <p id="modalDate" class="muted"></p>
        <p id="modalDesc"></p>
        <p class="muted">Source: <a id="modalLink" class="link" target="_blank" rel="noopener">NASA APOD</a></p>
        <div style="margin-top:12px;display:flex;gap:8px"><button onclick="closeModal()" class="btn">Close</button><button id="favBtn" class="btn">Save</button></div>
      </div>
    </div>
  </div>

<script>
// OrbitFeed: single-file app
// - Fetches last N days of NASA APOD
// - Caches results in localStorage with TTL
// - Fallback local data ensures UI always shows something
// - Magazine-style UI, modal to view full image and explanation

const DEMO_KEY = 'DEMO_KEY'; // default
const CACHE_KEY = 'orbitfeed:apod_cache_v1';
const CACHE_TTL = 1000 * 60 * 60 * 6; // 6 hours
const DAYS = 8; // number of days to fetch

// Simple local fallback (small curated set) — ensures UI never blank
const LOCAL_FALLBACK = [
  { date: '2025-11-01', title: 'Milky Way over Desert', explanation: 'A long-exposure image of the Milky Way...', url: 'https://www.nasa.gov/sites/default/files/styles/full_width_feature/public/thumbnails/image/piaxxxx.jpg', hdurl: 'https://via.placeholder.com/1200x800?text=Milky+Way' },
  { date: '2025-10-28', title: 'Aurora over Earth', explanation: 'Northern lights glowing...', url: 'https://via.placeholder.com/1200x800?text=Aurora', hdurl: 'https://via.placeholder.com/1200x800?text=Aurora' }
];

// DOM elements
const heroMedia = document.getElementById('heroMedia');
const heroTitle = document.getElementById('heroTitle');
const heroDesc = document.getElementById('heroDesc');
const heroMeta = document.getElementById('heroMeta');
const cards = document.getElementById('cards');
const feedMeta = document.getElementById('feedMeta');
const qInput = document.getElementById('q');
const refreshBtn = document.getElementById('refresh');
const apiKeyInput = document.getElementById('apiKey');
const openTodayBtn = document.getElementById('openToday');
const downloadAllBtn = document.getElementById('downloadAll');

let APOD_ITEMS = []; // array of APOD objects

// Utility: safe fetch JSON with timeout
async function fetchJson(url, opts = {}, timeout = 12000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try {
    const res = await fetch(url, { ...opts, signal: controller.signal });
    clearTimeout(id);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  } catch (e) {
    clearTimeout(id);
    console.warn('fetchJson failed', url, e && e.message);
    return null;
  }
}

// Cache helpers
function cacheSet(v) {
  try { localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), v })); } catch (e) { }
}
function cacheGet() {
  try {
    const raw = localStorage.getItem(CACHE_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || !obj.ts) return null;
    if (Date.now() - obj.ts > CACHE_TTL) { localStorage.removeItem(CACHE_KEY); return null; }
    return obj.v;
  } catch (e) { return null; }
}

// Build NASA APOD URL to fetch range
function buildApodRangeUrl(apiKey, startDate, endDate) {
  return `https://api.nasa.gov/planetary/apod?api_key=${encodeURIComponent(apiKey)}&start_date=${startDate}&end_date=${endDate}`;
}

function formatDate(d) {
  const yyyy = d.getFullYear(); const mm = String(d.getMonth() + 1).padStart(2, '0'); const dd = String(d.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

// Fetch last N days of APOD (returns array sorted descending by date)
async function fetchApodRange(apiKey, days) {
  // compute start & end
  const end = new Date();
  const start = new Date(); start.setDate(end.getDate() - (days - 1));
  const url = buildApodRangeUrl(apiKey, formatDate(start), formatDate(end));
  const data = await fetchJson(url);
  if (!data) return null;
  // API returns array when start_date is used; ensure sorted newest-first
  const arr = Array.isArray(data) ? data : [data];
  arr.sort((a, b) => new Date(b.date) - new Date(a.date));
  return arr;
}

// Render functions
function renderHero(item) {
  if (!item) return;
  heroMedia.classList.remove('skeleton');
  heroMedia.innerHTML = '';
  // handle video
  if (item.media_type === 'video') {
    const iframe = document.createElement('iframe');
    iframe.src = item.url; iframe.style.width = '100%'; iframe.style.height = '100%'; iframe.frameBorder = 0; iframe.allow = 'accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture';
    heroMedia.appendChild(iframe);
  } else {
    const img = document.createElement('img');
    img.src = item.hdurl || item.url; img.alt = item.title || 'APOD';
    heroMedia.appendChild(img);
  }
  heroTitle.textContent = item.title || 'Astronomy Picture';
  heroDesc.textContent = (item.explanation || '').slice(0, 220) + ((item.explanation || '').length > 220 ? '…' : '');
  heroMeta.innerHTML = `${item.date || ''} &nbsp; · &nbsp; <a href="${item.url}" target="_blank" rel="noopener" class="link">View on NASA</a>`;
}

function renderCards(items) {
  cards.innerHTML = '';
  items.forEach(item => {
    const card = document.createElement('article'); card.className = 'card';
    const thumb = document.createElement('div'); thumb.className = 'thumb';
    const img = document.createElement('img'); img.src = item.url || item.hdurl || 'https://via.placeholder.com/600x360?text=Space'; img.alt = item.title || 'APOD'; img.loading = 'lazy';
    thumb.appendChild(img);
    const meta = document.createElement('div'); meta.className = 'meta';
    const h3 = document.createElement('h3'); h3.textContent = item.title || 'Untitled';
    const p = document.createElement('p'); p.textContent = (item.explanation || '').slice(0, 140) + ((item.explanation||'').length>140 ? '…' : '');
    const mline = document.createElement('div'); mline.className = 'metaLine'; mline.innerHTML = `${item.date || ''} &nbsp; · &nbsp; <a class="link" href="#" onclick="openModal('${encodeURIComponent(item.date || '')}')">Read</a>`;
    meta.appendChild(h3); meta.appendChild(p); meta.appendChild(mline);
    card.appendChild(thumb); card.appendChild(meta);
    cards.appendChild(card);

    // clicking card opens modal for that date
    card.addEventListener('click', (e) => { if (e.target.tagName.toLowerCase() !== 'a') openModal(item.date); });
  });
}

// Modal behavior
function openModal(dateEncoded) {
  const date = typeof dateEncoded === 'string' ? decodeURIComponent(dateEncoded) : dateEncoded;
  const item = APOD_ITEMS.find(x => x.date === date);
  if (!item) return;
  document.getElementById('modal').style.display = 'flex';
  const modalMedia = document.getElementById('modalMedia');
  modalMedia.innerHTML = '';
  if (item.media_type === 'video') {
    const iframe = document.createElement('iframe'); iframe.src = item.url; iframe.style.width='100%'; iframe.style.height='100%'; iframe.frameBorder=0; iframe.allow='encrypted-media; fullscreen';
    modalMedia.appendChild(iframe);
  } else {
    const img = document.createElement('img'); img.src = item.hdurl || item.url; img.alt = item.title || 'APOD'; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='contain';
    modalMedia.appendChild(img);
  }
  document.getElementById('modalTitle').textContent = item.title || '';
  document.getElementById('modalDate').textContent = item.date || '';
  document.getElementById('modalDesc').textContent = item.explanation || '';
  const link = document.getElementById('modalLink'); link.href = item.url || '#'; link.textContent = 'NASA APOD';
}
function closeModal(evt) { if (evt) { if (evt.target.id !== 'modal') return; } document.getElementById('modal').style.display = 'none'; }

// Simple download images (zip is heavy; we'll open images in new tabs sequentially)
async function downloadAllImages() {
  for (const it of APOD_ITEMS) {
    const u = it.hdurl || it.url;
    if (!u) continue;
    window.open(u, '_blank');
    await new Promise(r => setTimeout(r, 300));
  }
}

// Main load flow
async function loadOrbitFeed(force = false) {
  // try cache
  if (!force) {
    const cached = cacheGet();
    if (cached && Array.isArray(cached) && cached.length) {
      APOD_ITEMS = cached;
      renderHero(APOD_ITEMS[0]);
      renderCards(APOD_ITEMS.slice(1));
      feedMeta.textContent = `Showing ${APOD_ITEMS.length} days (cached)`;
      return;
    }
  }

  // determine API key
  const userKey = (document.getElementById('apiKey').value || '').trim() || DEMO_KEY;
  const arr = await fetchApodRange(userKey, DAYS);
  if (arr && Array.isArray(arr) && arr.length) {
    APOD_ITEMS = arr;
    cacheSet(APOD_ITEMS);
    renderHero(APOD_ITEMS[0]);
    renderCards(APOD_ITEMS.slice(1));
    feedMeta.textContent = `Showing ${APOD_ITEMS.length} days`;
    return;
  }

  // fallback: use local fallback to avoid blank UI
  APOD_ITEMS = LOCAL_FALLBACK;
  renderHero(APOD_ITEMS[0]);
  renderCards(APOD_ITEMS.slice(1));
  feedMeta.textContent = `Showing fallback items`;
}

// Search functionality
qInput.addEventListener('input', () => {
  const q = qInput.value.trim().toLowerCase();
  if (!q) { renderCards(APOD_ITEMS.slice(1)); feedMeta.textContent = `Showing ${APOD_ITEMS.length} days`; return; }
  const filtered = APOD_ITEMS.filter(it => (it.title + ' ' + (it.explanation||'')).toLowerCase().includes(q));
  renderCards(filtered.slice(1));
  feedMeta.textContent = `Filtered: ${filtered.length} results`;
});

// Button hookups
refreshBtn.addEventListener('click', () => loadOrbitFeed(true));
openTodayBtn.addEventListener('click', () => { if (APOD_ITEMS.length) openModal(APOD_ITEMS[0].date); });
downloadAllBtn.addEventListener('click', downloadAllImages);

// Initial run
loadOrbitFeed(false);

// Expose modal open for links
window.openModal = openModal; window.closeModal = closeModal;

</script>
</body>
</html>
