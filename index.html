<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>orcus — Reliable Space News</title>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{--accent:#c21807;--muted:#6b6b6b;--max-width:1100px;--card-radius:12px;--bg:#fbfbfb}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#111}
    header{padding:18px;border-bottom:1px solid #eee;background:white;position:sticky;top:0;z-index:20}
    .top{max-width:var(--max-width);margin:0 auto;display:flex;align-items:center;gap:16px}
    .brand{font-family:Merriweather,serif;font-size:24px}
    .wrap{max-width:var(--max-width);margin:20px auto;padding:0 16px;display:grid;grid-template-columns:1fr 340px;gap:24px}
    @media(max-width:980px){.wrap{grid-template-columns:1fr}}
    .hero{background:white;border-radius:var(--card-radius);overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.04)}
    .media{width:100%;height:360px;background:#ddd;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .media img{width:100%;height:100%;object-fit:cover}
    .meta{padding:14px}
    .cards{display:flex;flex-direction:column;gap:12px;margin-top:8px}
    .card{background:white;border-radius:10px;padding:12px;display:flex;gap:12px;align-items:flex-start;box-shadow:0 6px 18px rgba(0,0,0,0.03)}
    .thumb{width:140px;height:88px;border-radius:8px;overflow:hidden;background:#eee;flex:0 0 140px}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .info h3{margin:0;font-size:16px}
    .info p{margin:8px 0 0;color:var(--muted);font-size:13px}
    aside .panel{background:white;padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.03);margin-bottom:12px}
    .small{font-size:13px;color:var(--muted)}
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .outline{background:#f3f3f3;color:#333;padding:8px;border-radius:8px;border:0;cursor:pointer}
    .skeleton{background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:shimmer 1.2s linear infinite}
    @keyframes shimmer{from{background-position:200% 0} to{background-position:-200% 0}}
    footer{text-align:center;padding:36px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <header>
    <div class="top">
      <div class="brand">orcus-NowInSpace</div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="refreshBtn" class="outline">Refresh</button>
        <button id="forceRefreshBtn" class="btn">Force refresh</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section>
      <div class="hero">
        <div id="heroMedia" class="media skeleton"></div>
        <div class="meta">
          <h2 id="heroTitle">Loading featured astronomy image…</h2>
          <p id="heroDesc" class="small">Fetching APOD (cached for reliability).</p>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px">
        <h3 style="margin:0">Latest space news</h3>
        <div id="newsMeta" class="small">Loading…</div>
      </div>

      <div id="newsCards" class="cards" style="margin-top:8px"></div>
    </section>

    <aside>
      <div class="panel">
        <h4 style="margin:0 0 8px 0">Upcoming launches</h4>
        <div id="launchList" class="small">Loading launches…</div>
      </div>

      <div class="panel">
        <h4 style="margin:0 0 8px 0">ISS Right Now</h4>
        <div id="issInfo" class="small">Loading ISS position…</div>
      </div>

      <div class="panel">
        <h4 style="margin:0 0 8px 0">Status</h4>
        <div id="statusBox" class="small">Initializing…</div>
      </div>
    </aside>
  </main>

  <footer>Built for reliability • Cached + fallback data • Host on GitHub Pages</footer>

<script>
/*
NowInSpace — Reliable client-only version
Features:
- NASA APOD (cached)
- Spaceflight news (primary API) with local backup fallback
- TheSpaceDevs launches with fallback
- ISS location (wheretheiss.at) cached short-term
- localStorage caching with TTL and retry logic
*/

const NASA_API_KEY = 'gs6lRgopzIcyZJVBliOsyXKZnwCEii5w0OBidaVk'; // replace to avoid rate limits
const NEWS_TTL_MS = 1000 * 60 * 30; // 30 minutes
const APOD_TTL_MS = 1000 * 60 * 60 * 6; // 6 hours
const LAUNCH_TTL_MS = 1000 * 60 * 30; // 30 minutes
const ISS_TTL_MS = 10000; // 10s for ISS (but still cached between intervals)

const LOCAL_BACKUP_NEWS = [
  // Minimal local backup to ensure UI never blank (title, summary, url, image, source, publishedAt)
  { title: "NASA's Webb releases stunning deep-field images", summary: "NASA's James Webb Space Telescope released a set of deep-field images showing early galaxies.", url: "https://www.nasa.gov/", image: "https://via.placeholder.com/600x360?text=Webb", source: "NASA", publishedAt: new Date().toISOString() },
  { title: "Commercial launch reaches orbit", summary: "A commercial provider successfully places small satellites into orbit.", url: "https://spaceflightnow.com/", image: "https://via.placeholder.com/600x360?text=Launch", source: "SpaceNews", publishedAt: new Date().toISOString() },
  { title: "New instrument to study Mars atmosphere", summary: "A new instrument will be sent to Mars to study atmospheric composition.", url: "https://www.esa.int/", image: "https://via.placeholder.com/600x360?text=Mars", source: "ESA", publishedAt: new Date().toISOString() }
];

const LOCAL_BACKUP_LAUNCHES = [
  { name: "Demo Rocket — Demo Mission", net: new Date(Date.now() + 86400000).toISOString(), image: null },
  { name: "Test Satellite Launch", net: new Date(Date.now() + 3*86400000).toISOString(), image: null }
];

// Utils: localStorage cache helpers
function cacheSet(key, value) {
  const obj = { ts: Date.now(), v: value };
  try { localStorage.setItem('nowinspace:' + key, JSON.stringify(obj)); } catch(e){}
}
function cacheGet(key, ttlMs=Infinity) {
  try {
    const raw = localStorage.getItem('nowinspace:' + key);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || !obj.ts) return null;
    if (Date.now() - obj.ts > ttlMs) { localStorage.removeItem('nowinspace:' + key); return null; }
    return obj.v;
  } catch(e){ return null; }
}

// small safe fetch wrapper with retries
async function fetchWithRetries(url, opts={}, attempts=2, delayMs=800) {
  for (let i=0;i<attempts;i++){
    try {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) return await res.json();
      return await res.text();
    } catch(e) {
      console.warn('fetch error', url, e && e.message);
      if (i < attempts -1) await new Promise(r=>setTimeout(r, delayMs));
    }
  }
  return null;
}

/* APOD (NASA) */
async function loadAPOD(force=false) {
  const heroMedia = document.getElementById('heroMedia');
  const heroTitle = document.getElementById('heroTitle');
  const heroDesc = document.getElementById('heroDesc');
  // try cache
  if (!force) {
    const cached = cacheGet('apod', APOD_TTL_MS);
    if (cached) {
      showAPOD(cached);
      return cached;
    }
  }

  const url = `https://api.nasa.gov/planetary/apod?api_key=${encodeURIComponent(NASA_API_KEY)}`;
  const data = await fetchWithRetries(url, {}, 2, 900);
  if (!data) {
    // show cached if any or fallback
    const cached = cacheGet('apod', Infinity);
    if (cached) { showAPOD(cached); return cached; }
    heroMedia.className = 'media'; heroMedia.innerHTML = '<div style="padding:20px">APOD unavailable</div>';
    heroTitle.textContent = 'Astronomy Picture';
    heroDesc.textContent = 'Could not fetch APOD.';
    return null;
  }
  cacheSet('apod', data);
  showAPOD(data);
  return data;
}
function showAPOD(data) {
  const heroMedia = document.getElementById('heroMedia');
  const heroTitle = document.getElementById('heroTitle');
  const heroDesc = document.getElementById('heroDesc');
  heroMedia.className = 'media';
  if (data.media_type === 'video') {
    heroMedia.innerHTML = `<iframe src="${data.url}" style="width:100%;height:100%;border:0" title="APOD video" frameborder="0" allowfullscreen></iframe>`;
  } else {
    const img = document.createElement('img'); img.src = data.url; img.alt = data.title || 'APOD';
    heroMedia.innerHTML = ''; heroMedia.appendChild(img);
  }
  heroTitle.textContent = data.title || 'Astronomy Picture';
  heroDesc.textContent = (data.explanation || '').slice(0, 220) + ((data.explanation||'').length>220 ? '…' : '');
}

/* News: primary API (Spaceflight) with backup */
async function loadNews(force=false) {
  const meta = document.getElementById('newsMeta');
  meta.textContent = 'Loading news…';
  if (!force) {
    const cached = cacheGet('news', NEWS_TTL_MS);
    if (cached) { NEWS_ITEMS = cached; renderNewsCards(NEWS_ITEMS); meta.textContent = `Showing ${NEWS_ITEMS.length} articles (cached)`; return cached; }
  }

  const endpoint = 'https://api.spaceflightnewsapi.net/v3/articles?_limit=12';
  const data = await fetchWithRetries(endpoint, {}, 2, 800);
  if (data && Array.isArray(data) && data.length>0) {
    const items = data.map(it => ({
      title: it.title || it.name || '',
      summary: it.summary || it.summary || '',
      url: it.url || it.link || '',
      image: it.imageUrl || it.image_url || it.image || '',
      source: it.newsSite || it.source || '',
      publishedAt: it.publishedAt || it.published_at || ''
    }));
    NEWS_ITEMS = items;
    cacheSet('news', items);
    renderNewsCards(items);
    meta.textContent = `Showing ${items.length} articles`;
    return items;
  }

  // fallback: local backup
  console.warn('Spaceflight API failed — using local backup');
  NEWS_ITEMS = LOCAL_BACKUP_NEWS;
  cacheSet('news', NEWS_ITEMS);
  renderNewsCards(NEWS_ITEMS);
  meta.textContent = `Showing ${NEWS_ITEMS.length} articles (backup)`;
  return NEWS_ITEMS;
}

function renderNewsCards(items) {
  const container = document.getElementById('newsCards');
  container.innerHTML = '';
  if (!items || !items.length) { container.innerHTML = '<div class="small">No news available</div>'; return; }
  items.forEach(it => {
    const card = document.createElement('article'); card.className='card';
    const thumb = document.createElement('div'); thumb.className='thumb';
    const img = document.createElement('img'); img.src = it.image || it.imageUrl || 'https://via.placeholder.com/600x360?text=Space'; img.alt = it.title || 'img';
    thumb.appendChild(img);
    const info = document.createElement('div'); info.className='info';
    const h3 = document.createElement('h3'); h3.textContent = it.title || '';
    const p = document.createElement('p'); p.textContent = (it.summary||'').replace(/<[^>]+>/g,'').slice(0,160) + ((it.summary||'').length>160 ? '…' : '');
    const meta = document.createElement('div'); meta.className='small';
    const d = new Date(it.publishedAt || it.pubDate || Date.now());
    meta.innerHTML = `${it.source || ''} ${isNaN(d)?'':'· ' + d.toLocaleDateString()} &nbsp; <a href="${it.url||it.link||'#'}" class="small" target="_blank" rel="noopener">Read source</a>`;
    info.appendChild(h3); info.appendChild(p); info.appendChild(meta);
    card.appendChild(thumb); card.appendChild(info);
    container.appendChild(card);
  });
}

/* Launches with fallback */
async function loadLaunches(force=false) {
  const cached = !force ? cacheGet('launches', LAUNCH_TTL_MS) : null;
  if (cached) { renderLaunches(cached); return cached; }
  const endpoint = 'https://ll.thespacedevs.com/2.2.0/launch/upcoming/?limit=6&mode=detailed';
  const data = await fetchWithRetries(endpoint, {}, 2, 1000);
  if (data && data.results && data.results.length) {
    cacheSet('launches', data.results);
    renderLaunches(data.results);
    return data.results;
  }
  console.warn('Launches API failed — using backup');
  cacheSet('launches', LOCAL_BACKUP_LAUNCHES);
  renderLaunches(LOCAL_BACKUP_LAUNCHES);
  return LOCAL_BACKUP_LAUNCHES;
}
function renderLaunches(items) {
  const list = document.getElementById('launchList'); list.innerHTML = '';
  items.forEach(ln => {
    const el = document.createElement('div'); el.style.marginBottom='12px';
    const name = document.createElement('div'); name.textContent = ln.name || ln.mission || 'Unnamed'; name.style.fontWeight=600;
    const t = new Date(ln.net || ln.window_start || ln.date || Date.now());
    const dt = document.createElement('div'); dt.className='small'; dt.textContent = isNaN(t)?'TBA':t.toLocaleString();
    const countdown = document.createElement('div'); countdown.className='small'; countdown.style.fontWeight=600; countdown.style.color='var(--accent)';
    countdown.setAttribute('data-net', ln.net || ln.window_start || ln.date || '');
    updateCountdownElement(countdown);
    el.appendChild(name); el.appendChild(dt); el.appendChild(countdown);
    list.appendChild(el);
  });
  if (!window._nowinspace_launch_tick) {
    window._nowinspace_launch_tick = setInterval(()=> document.querySelectorAll('[data-net]').forEach(updateCountdownElement), 1000);
  }
}
function updateCountdownElement(el) {
  const net = el.getAttribute('data-net'); if(!net) { el.textContent='TBA'; return; }
  const diff = new Date(net) - new Date();
  if (isNaN(diff)) { el.textContent='TBA'; return; }
  if (diff <= 0) { el.textContent='Launched'; return; }
  const s = Math.floor(diff/1000), days=Math.floor(s/86400), hrs=Math.floor((s%86400)/3600), mins=Math.floor((s%3600)/60), secs=s%60;
  el.textContent = (days>0?days+'d ':'') + String(hrs).padStart(2,'0') + ':' + String(mins).padStart(2,'0') + ':' + String(secs).padStart(2,'0');
}

/* ISS position (short-term cached) */
async function loadISS(force=false) {
  const cached = !force ? cacheGet('iss', ISS_TTL_MS) : null;
  const info = document.getElementById('issInfo');
  if (cached) { info.innerHTML = formatISS(cached); return cached; }
  const url = 'https://api.wheretheiss.at/v1/satellites/25544';
  const data = await fetchWithRetries(url, {}, 2, 800);
  if (data) { cacheSet('iss', data); info.innerHTML = formatISS(data); return data; }
  info.textContent = 'ISS unavailable';
  return null;
}
function formatISS(d) {
  return `Latitude: ${d.latitude.toFixed(2)}°, Longitude: ${d.longitude.toFixed(2)}° <br> Alt: ${d.altitude?d.altitude.toFixed(1)+' km':''} • Vel: ${d.velocity?d.velocity.toFixed(1)+' km/h':''}`;
}

/* Controls and init */
let NEWS_ITEMS = [];

document.getElementById('refreshBtn').addEventListener('click', () => {
  document.getElementById('statusBox').textContent = 'Soft refresh… (will use cache if fresh)';
  loadAll(false);
});
document.getElementById('forceRefreshBtn').addEventListener('click', () => {
  document.getElementById('statusBox').textContent = 'Force refresh — ignoring caches';
  // clear caches
  ['apod','news','launches','iss'].forEach(k => localStorage.removeItem('nowinspace:' + k));
  loadAll(true);
});

async function loadAll(force=false) {
  document.getElementById('statusBox').textContent = 'Loading data…';
  try {
    await Promise.all([ loadAPOD(force), loadNews(force), loadLaunches(force), loadISS(force) ]);
    document.getElementById('statusBox').textContent = 'Loaded (cached + fallback enabled)';
  } catch(e) {
    console.warn('loadAll error', e);
    document.getElementById('statusBox').textContent = 'Some data failed to load — using cached/fallback data if available';
  }
}

// Initial load
loadAll(false);

// Periodic background refresh: attempt to refresh news every 15 minutes (soft — preserves cached TTL logic)
setInterval(() => { loadNews(false); }, 1000 * 60 * 15);
</script>
</body>
</html>
